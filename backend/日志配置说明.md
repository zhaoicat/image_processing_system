# 日志系统配置说明

## 日志配置概述

本项目使用Django的内置日志系统进行日志记录。日志配置位于`image_processing/settings.py`文件中的`LOGGING`部分。

## 日志格式

日志格式为：
```
[时间戳] 日志级别 [模块:行号] - 消息
```

例如：
```
[2025-05-23 08:29:45] INFO [tasks.tasks:38] - 当前目录: /path/to/dir
```

## 日志存储

日志同时输出到以下位置：
1. 控制台
2. 日志文件：`backend/logs/app.log`（自动轮转，保留5个备份文件，每个文件最大10MB）

## 日志级别

各模块的日志级别设置如下：
- Django框架：INFO
- tasks模块：DEBUG
- 其他模块：DEBUG

## 正确启动服务器

为确保日志配置正确加载，请使用以下方式启动服务器：

```bash
# 方法1：使用启动脚本
./start_server.sh

# 方法2：手动设置环境变量
export DJANGO_SETTINGS_MODULE=image_processing.settings
python manage.py runserver 8888
```

## 日志代码编写最佳实践

1. 使用懒加载格式（不使用f-string）：
```python
# 推荐
logger.info("处理图像: %s", image_path)

# 不推荐
logger.info(f"处理图像: {image_path}")
```

2. 使用适当的日志级别：
   - DEBUG: 详细调试信息
   - INFO: 一般信息
   - WARNING: 警告信息
   - ERROR: 错误信息
   - CRITICAL: 严重错误信息

3. 在记录异常时，包含完整的堆栈跟踪：
```python
try:
    # 代码
except Exception as e:
    logger.error("发生错误: %s", str(e))
    logger.error(traceback.format_exc())
```

## 重启服务器后Token失效问题

### 问题描述

当后台服务器重启后，用户可能会出现即使输入正确的用户名和密码也无法登录的情况。这是因为：

1. Django重启后会生成新的JWT密钥，导致之前签发的令牌失效
2. 前端浏览器中保存的旧令牌会被服务器拒绝
3. 用户需要清理浏览器中的无效令牌才能重新登录

### 解决方案

我们通过以下方式解决了这个问题：

1. 在前端添加了自动检测无效令牌的功能，当检测到401未授权错误时会自动清理本地存储的令牌
2. 添加了令牌清理模态框组件，提示用户重新登录
3. 通过Axios拦截器实现全局错误处理

用户不再需要手动清理令牌，系统会自动处理这种情况并引导用户重新登录。 