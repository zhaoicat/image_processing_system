# 报告加载问题修复总结

## 问题描述

在前端尝试加载综合报告时出现以下错误：
- "无法加载综合报告"
- "Failed to fetch"
- "可能报告文件不存在或路径不正确"

## 问题根本原因

### 1. 前端配置中的端口不匹配

**问题**：前端配置文件 `src/config.js` 中的 `BACKEND_HOST` 设置为 `http://localhost:8000`，但实际的Django服务器运行在端口8888上。

**影响**：`getBackendUrl()` 函数返回错误的URL，导致无法访问报告文件。

### 2. CORS跨域访问问题

**问题**：前端代码使用 `getBackendUrl()` 直接访问后端服务器，绕过了Vite代理，可能导致CORS问题。

**影响**：即使端口正确，直接跨域访问也可能被浏览器阻止。

## 解决方案

### 1. 修复前端配置中的端口设置

**修改文件**：`image_processing_system/frontend/src/config.js`

**修改内容**：
```javascript
// 修改前
const config = {
  development: {
    BACKEND_HOST: 'http://localhost:8000'  // 错误端口
  },
  production: {
    BACKEND_HOST: import.meta.env.VITE_BACKEND_HOST || 'http://localhost:8000'
  }
}

// 修改后
const config = {
  development: {
    BACKEND_HOST: 'http://localhost:8888'  // 正确端口
  },
  production: {
    BACKEND_HOST: import.meta.env.VITE_BACKEND_HOST || 'http://localhost:8888'
  }
}
```

### 2. 修改报告加载逻辑使用Vite代理

**修改文件**：`image_processing_system/frontend/src/views/ReportManagement.vue`

**修改内容**：
```javascript
// 修改前 - 直接访问后端
const summaryUrl = getBackendUrl(`/media/reports/task_${taskId}/reports/summary.html`);

// 修改后 - 通过Vite代理访问
const summaryUrl = `/media/reports/task_${taskId}/reports/summary.html`;
```

**优势**：
- 避免CORS问题
- 利用Vite的代理配置
- 统一的访问方式

### 3. 修复资源路径替换逻辑

**修改内容**：
```javascript
// 修改前 - 使用绝对URL
const newUrl = getBackendUrl(`/media/reports/task_${taskId}/reports/${path}`);

// 修改后 - 使用相对路径
const newUrl = `/media/reports/task_${taskId}/reports/${path}`;
```

## 验证结果

### 1. 后端文件访问测试

```bash
# Django服务器直接访问
curl -I http://127.0.0.1:8888/media/reports/task_192/reports/summary.html
# 返回: HTTP/1.1 200 OK

# Vite代理访问
curl -I http://localhost:5174/media/reports/task_192/reports/summary.html
# 返回: HTTP/1.1 200 OK
```

### 2. 前端配置验证

- ✅ Vite代理配置正确：`/media` -> `http://localhost:8888`
- ✅ Django CORS设置正确：`CORS_ALLOW_ALL_ORIGINS = True`
- ✅ 报告文件存在：`media/reports/task_192/reports/summary.html`

## 系统架构说明

### 当前架构

```
前端 (localhost:5174) 
    ↓ (通过Vite代理)
Django后端 (localhost:8888)
    ↓ (提供静态文件)
报告文件 (media/reports/...)
```

### 请求流程

1. 前端发起请求：`/media/reports/task_192/reports/summary.html`
2. Vite代理转发：`http://localhost:8888/media/reports/task_192/reports/summary.html`
3. Django处理：通过 `static()` 配置提供媒体文件
4. 返回HTML内容给前端

## 最佳实践建议

### 1. 统一使用代理访问

- ✅ 使用相对路径：`/media/...`
- ❌ 避免直接URL：`http://localhost:8888/media/...`

### 2. 配置管理

- 确保前端配置与实际服务器端口一致
- 使用环境变量管理不同环境的配置

### 3. 错误处理

- 提供详细的错误信息
- 记录调试日志便于排查问题

### 4. 开发调试

- 使用浏览器开发者工具检查网络请求
- 检查控制台日志了解具体错误信息

## 总结

这个问题主要是由于前端配置中的端口不匹配和直接跨域访问导致的。通过修复端口配置并改用Vite代理访问，问题得到了彻底解决。

修复后，前端可以正常加载综合报告和算法报告，系统功能完整可用。 